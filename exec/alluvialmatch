#!/usr/bin/env Rscript

args <- commandArgs(trailingOnly = TRUE)

# Install devtools if needed
if (!requireNamespace("devtools", quietly = TRUE)) {
  if (interactive()) {
    install <- askYesNo("The 'devtools' package is required but not installed. Install it now?")
    if (isTRUE(install)) {
      install.packages("devtools", repos = "https://cloud.r-project.org")
    } else {
      stop("Aborted. Please install 'devtools' manually with install.packages('devtools').")
    }
  } else {
    stop("The 'devtools' package is required. Please install it with install.packages('devtools').")
  }
}

# Install your package's runtime dependencies if missing
required_pkgs <- c(
  "dplyr", "ggplot2", "ggforce", "ggalluvial", "igraph",
  "tibble", "rlang", "tidyr", "magrittr", "data.table"
)

missing <- required_pkgs[!vapply(required_pkgs, requireNamespace, quietly = TRUE, FUN.VALUE = logical(1))]
if (length(missing) > 0) {
  msg <- paste("The following required packages are missing:\n  ",
               paste(missing, collapse = ", "),
               "\nInstall them now?")
  if (interactive()) {
    install <- askYesNo(msg)
    if (isTRUE(install)) {
      install.packages(missing, repos = "https://cloud.r-project.org")
    } else {
      stop("Aborted. Please install the missing packages manually.")
    }
  } else {
    stop("Missing packages: ", paste(missing, collapse = ", "),
         "\nPlease install them with install.packages().")
  }
}

# Load the package from the local directory
args_full <- commandArgs(trailingOnly = FALSE)
script_path <- sub("^--file=", "", args_full[grep("^--file=", args_full)])
if (length(script_path) == 0) stop("Failed to detect script path.")
package_root <- dirname(dirname(script_path))
setwd(package_root)

devtools::load_all(".")
alluvialmatch::run_cli(args)
