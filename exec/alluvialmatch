#!/usr/bin/env Rscript

args <- commandArgs(trailingOnly = TRUE)

## if doing development, then comment this out, and uncomment the package installation and devtools thing
#if (!requireNamespace("alluvialmatch", quietly = TRUE)) {
#  message("alluvialmatch not installed. Installing now...")
#  install.packages("alluvialmatch")
#}


# Install your package's runtime dependencies if missing
required_pkgs <- c(
  "dplyr", "ggplot2", "ggforce", "ggalluvial", "igraph",
  "tibble", "rlang", "tidyr", "magrittr", "data.table"
)

missing <- required_pkgs[!vapply(required_pkgs, requireNamespace, quietly = TRUE, FUN.VALUE = logical(1))]
if (length(missing) > 0) {
  msg <- paste("The following required packages are missing:\n  ",
               paste(missing, collapse = ", "),
               "\nInstall them now?")
  if (interactive()) {
    install <- askYesNo(msg)
    if (isTRUE(install)) {
      install.packages(missing, repos = "https://cloud.r-project.org")
    } else {
      stop(
        paste0(
            "Aborted. Please install the missing packages manually:\n",
            "Rscript -e 'install.packages(c(",
            paste0(sprintf('\"%s\"', missing), collapse = ", "),
            "))'\n"
        )
    )

    }
  } else {
    stop(
        paste0(
            "Missing packages: ", paste(missing, collapse = ", "), "\n",
            "To install them, run:\n",
            "Rscript install.R",
            "or",
            "Rscript -e 'install.packages(c(",
            paste0(sprintf('\"%s\"', missing), collapse = ", "),
            "))'\n"
        )
    )
  }
}


## Install devtools if needed for active development
#if (!requireNamespace("devtools", quietly = TRUE)) {
#  if (interactive()) {
#    install <- askYesNo("The 'devtools' package is required but not installed. Install it now?")
#    if (isTRUE(install)) {
#      install.packages("devtools", repos = "https://cloud.r-project.org")
#    } else {
#      stop("Aborted. Please install 'devtools' manually with install.packages('devtools') or Rscript -e 'install.packages(c("devtools"), repos="https://cloud.r-project.org").")
#    }
#  } else {
#    stop("The 'devtools' package is required. Please install it with install.packages('devtools') or Rscript -e 'install.packages(c("devtools"), repos="https://cloud.r-project.org").")
#  }
#}

 devtools::load_all(".")

# Load the package from the local directory
args_full <- commandArgs(trailingOnly = FALSE)
script_path <- sub("^--file=", "", args_full[grep("^--file=", args_full)])
if (length(script_path) == 0) stop("Failed to detect script path.")
package_root <- dirname(dirname(script_path))
setwd(package_root)

alluvialmatch::run_cli(args)
