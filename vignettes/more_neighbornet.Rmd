---
title: "Introduction to alluvialmatch"
output: rmarkdown::html_vignette
vignette: >
  %\VignetteIndexEntry{Introduction to alluvialmatch}
  %\VignetteEngine{knitr::rmarkdown}
  %\VignetteEncoding{UTF-8}
---

```{r}
devtools::load_all()
# library(alluvialmatch)
library(dplyr)
library(ggplot2)
library(ggalluvial)
library(ggforce)
library(igraph)
library(tibble)
library(tidyr)
library(reticulate)

alluvialmatch::setup_python_env()  #!!! erase
```

Set up our python environment
```{r setup-env, eval = FALSE}
alluvialmatch::setup_python_env()
```

```{r check-python, include = FALSE}
if (!reticulate::py_module_available("splitspy")) {
    message("‚ùå 'splitspy' not found. Run alluvialmatch::setup_python_env() and restart R.")
    knitr::knit_exit()
}
```

```{r}
df <- data.frame(
  tissue = c(
    1, 1, 1,
    2, 2, 2, 2, 2, 2,
    3, 3, 3, 3, 3, 3, 3,
    4, 4,
    5, 5, 5, 5, 5, 5, 5, 5, 5
  ),
  cluster = c(
    6, 6, 7,
    6, 7, 7, 7, 7, 7,
    6, 8, 8, 8, 8, 8, 8,
    8, 8,
    8, 8, 8, 8, 8, 8, 8, 8, 8
  )
)
column1 <- "tissue"
column2 <- "cluster"
graphing_columns <- c(column1, column2)

# clus_df_gather_raw <- df |>
#     dplyr::mutate_if(is.numeric, function(x) factor(x, levels = as.character(sort(unique(x))))) |>
#     dplyr::group_by_all() |>
#     dplyr::count(name = "value")
# gather_set_data(clus_df_gather_raw, 1:2)

plot_alluvial(df, graphing_columns = graphing_columns, sorting_algorithm = "None", color_bands=TRUE)
```

```{r}
# best: "cluster_6" "tissue_1"  "cluster_7" "tissue_2"  "tissue_5"  "cluster_8" "tissue_4"  "tissue_3" 
devtools::load_all()
plot_alluvial(df, graphing_columns = graphing_columns, sorting_algorithm = "neighbornet", color_bands=TRUE, optimize_column_order_per_cycle = FALSE)
```

3+ columns
```{r}
df <- data.frame(
  tissue = c(
    "BRAIN", "BRAIN", "BRAIN",
    "STOMACH", "STOMACH", "STOMACH", "STOMACH", "STOMACH", "STOMACH",
    "HEART", "HEART", "HEART", "HEART", "HEART", "HEART", "HEART",
    "T CELL", "T CELL",
    "B CELL", "B CELL", "B CELL", "B CELL", "B CELL", "B CELL", "B CELL", "B CELL", "B CELL"
  ),
  cluster = c(
    1, 1, 2,
    1, 2, 2, 2, 2, 2,
    1, 3, 3, 3, 3, 3, 3,
    4, 4,
    4, 4, 4, 4, 4, 4, 4, 4, 4
  ),
  sex = c(
    "male", "female", "male",
    "female", "male", "female", "female", "male", "female",
    "male", "female", "male", "female", "male", "female", "male",
    "female", "male",
    "female", "male", "female", "male", "female", "male", "female", "female", "male"
  )
)
graphing_columns <- c("tissue", "cluster", "sex")

plot_alluvial(df, graphing_columns = graphing_columns, sorting_algorithm = "None", color_bands=TRUE)
```

```{r}
devtools::load_all()
plot_alluvial(df, graphing_columns = graphing_columns, sorting_algorithm = "neighbornet", color_bands=TRUE, optimize_column_order=FALSE, optimize_column_order_per_cycle=FALSE)
```

```{r}
plot_alluvial(df, graphing_columns = graphing_columns, sorting_algorithm = "neighbornet", color_bands=TRUE, optimize_column_order=FALSE, optimize_column_order_per_cycle = TRUE)
```


Both, score 83
[[1]]
   1 2 3 4 5 6 7 8 9 10 11 12 13
1  0 0 0 0 0 5 0 0 0  0  0  0  5
2  0 0 0 0 0 4 0 0 0  0  0  0  0
3  0 0 0 0 0 0 0 0 0  0  0  0  0
4  0 0 0 0 0 0 0 0 0  0  0  0  0
5  0 0 0 0 0 0 0 0 1  0  0  0  0
6  5 4 0 0 0 0 0 0 0  0  0  1  1
7  0 0 0 0 0 0 0 0 0  0  0  0  0
8  0 0 0 0 0 0 0 0 0  0  0  0  0
9  0 0 0 0 1 0 0 0 0  0  0  0  0
10 0 0 0 0 0 0 0 0 0  0  0  0  0
11 0 0 0 0 0 0 0 0 0  0  0  0  0
12 0 0 0 0 0 1 0 0 0  0  0  0  0
13 5 0 0 0 0 1 0 0 0  0  0  0  0

[[2]]
    1  2 3 4 5 6  7 8 9 10 11 12 13
1   0  0 0 5 5 5  0 0 0  0 10  0  0
2   0  0 0 0 0 0 12 0 0  0  0  0  0
3   0  0 0 0 1 0  0 0 0  0  2  0  0
4   5  0 0 0 0 0  3 0 0  0  0  1  0
5   5  0 1 0 0 0  3 0 1  0  0  1  0
6   5  0 0 0 0 0  3 0 0  0  0  1  0
7   0 12 0 3 3 3  0 0 0  0  6  0  3
8   0  0 0 0 0 0  0 0 0  0  0  0  0
9   0  0 0 0 1 0  0 0 0  0  2  0  0
10  0  0 0 0 0 0  0 0 0  0  0  0  0
11 10  0 2 0 0 0  6 0 2  0  0  2  0
12  0  0 0 1 1 1  0 0 0  0  2  0  0
13  0  0 0 0 0 0  3 0 0  0  0  0  0

Good, score 86
[[1]]
   1 2 3 4 5 6 7 8 9 10 11 12 13
1  0 0 0 0 0 5 0 0 0  0  0  0  0
2  0 0 0 0 0 4 0 0 0  0  0  4  0
3  0 0 0 0 0 1 0 0 0  0  0  0  0
4  0 0 0 0 0 0 0 0 1  0  0  0  0
5  0 0 0 0 0 0 0 0 1  3  0  0  0
6  5 4 1 0 0 0 0 0 1  0  0  1  1
7  0 0 0 0 0 0 0 0 0  0  0  0  0
8  0 0 0 0 0 0 0 0 0  0  0  0  0
9  0 0 0 1 1 1 0 0 0  0  0  0  0
10 0 0 0 0 3 0 0 0 0  0  0  0  0
11 0 0 0 0 0 0 0 0 0  0  0  0  0
12 0 4 0 0 0 1 0 0 0  0  0  0  0
13 0 0 0 0 0 1 0 0 0  0  0  0  0

[[2]]
    1  2 3 4 5 6 7  8 9 10 11 12 13
1   0  0 0 0 0 0 0 15 0  0  0  0  0
2   0  0 4 0 0 0 0  0 4 12  0  0  0
3   0  4 0 0 0 0 0  3 0  0  0  0  1
4   0  0 0 0 0 0 0  0 0  3  0  0  0
5   0  0 0 0 0 0 0  0 0  0  0  0  0
6   0  0 0 0 0 0 0  0 0  3  0  0  0
7   0  0 0 0 0 0 0  0 0  0  0  0  0
8  15  0 3 0 0 0 0  0 3  9  0  3  0
9   0  4 0 0 0 0 0  3 0  0  0  0  1
10  0 12 0 3 0 3 0  9 0  0  0  0  3
11  0  0 0 0 0 0 0  0 0  0  0  0  0
12  0  0 0 0 0 0 0  3 0  0  0  0  0
13  0  0 1 0 0 0 0  0 1  3  0  0  0



```{r}
plot_alluvial(df, graphing_columns = graphing_columns, sorting_algorithm = "neighbornet", color_bands=TRUE, optimize_column_order=TRUE, optimize_column_order_per_cycle = FALSE)
```


```{r}
plot_alluvial(df, graphing_columns = graphing_columns, sorting_algorithm = "neighbornet", color_bands=TRUE, optimize_column_order=TRUE, optimize_column_order_per_cycle=TRUE)
```

```{r}
sessioninfo::session_info()
```



BONUS: Let's try on an extreme example
```{r}
df <- data.frame(
  tissue = c(
    "BRAIN", "BRAIN", "BRAIN",
    "STOMACH", "STOMACH", "STOMACH", "STOMACH", "STOMACH", "STOMACH",
    "HEART", "HEART", "HEART", "HEART", "HEART", "HEART", "HEART",
    "T CELL", "T CELL",
    "B CELL", "B CELL", "B CELL", "B CELL", "B CELL", "B CELL", "B CELL", "B CELL", "B CELL"
  ),
  sex = c(
    "male", "female", "male",
    "female", "male", "female", "female", "male", "female",
    "male", "female", "male", "female", "male", "female", "male",
    "female", "male",
    "female", "male", "female", "male", "female", "male", "female", "female", "male"
  ),
  cluster = c(
    "BRAIN", "BRAIN", "BRAIN",
    "STOMACH", "STOMACH", "STOMACH", "STOMACH", "STOMACH", "STOMACH",
    "HEART", "HEART", "HEART", "HEART", "HEART", "HEART", "HEART",
    "T CELL", "T CELL",
    "B CELL", "B CELL", "B CELL", "B CELL", "B CELL", "B CELL", "B CELL", "B CELL", "B CELL"
  )
)
graphing_columns <- c("tissue", "sex", "cluster")

plot_alluvial(df, graphing_columns = graphing_columns, sorting_algorithm = "None", color_bands=TRUE)
```

```{r}
plot_alluvial(df, graphing_columns = graphing_columns, sorting_algorithm = "neighbornet", color_bands=TRUE, optimize_column_order=FALSE)
```

```{r}
plot_alluvial(df, graphing_columns = graphing_columns, sorting_algorithm = "neighbornet", color_bands=TRUE, optimize_column_order=TRUE)
```


