---
title: "Introduction to alluvialmatch"
output: rmarkdown::html_vignette
vignette: >
  %\VignetteIndexEntry{Introduction to alluvialmatch}
  %\VignetteEngine{knitr::rmarkdown}
  %\VignetteEncoding{UTF-8}
---

```{r}
devtools::load_all()
# library(alluvialmatch)
library(dplyr)
library(ggplot2)
library(ggalluvial)
library(ggforce)
library(igraph)
library(tibble)
```

We create a toy data frame that maps tissues (brain, stomach, heart, T cell, B cell) to clustering (1-4)
```{r}
df <- data.frame(
  tissue = c(
    "brain", "brain", "brain",
    "stomach", "stomach", "stomach", "stomach", "stomach", "stomach",
    "heart", "heart", "heart", "heart", "heart", "heart", "heart",
    "T cell", "T cell",
    "B cell", "B cell", "B cell", "B cell", "B cell", "B cell", "B cell", "B cell", "B cell"
  ),
  cluster = c(
    2, 2, 1,
    2, 1, 1, 1, 1, 1,
    2, 3, 3, 3, 3, 3, 3,
    4, 4,
    4, 4, 4, 4, 4, 4, 4, 4, 4
  )
)

head(df)
```

Implementing a greedy heuristic for weighted one-layer free problem
```{r}
clus_df_gather_sorted <- greedy_wolf(df, column1="tissue", column2="cluster")
crossing_edges <- determine_crossing_edges(clus_df_gather_sorted, column1 = "tissue", column2 = "cluster")
alluvialmatch_objective <- determine_weighted_layer_free_objective(crossing_edges)
print(alluvialmatch_objective)
```

Plot the alluvial plot with sorting and color matching
```{r}
p1 <- plot_alluvial(clus_df_gather_sorted, column1="tissue", column2="cluster", column_weights = "value", show_group_2_box_labels_in_ascending = FALSE)
p1
```

```{r}
p1 <- plot_alluvial(clus_df_gather_sorted, column1="tissue", column2="cluster", column_weights = "value", show_group_2_box_labels_in_ascending = TRUE)
p1
```


Repeat for all permutations of the right side, calculating objective for each one
```{r}
# Sample: assume clus_df_gather_sorted has factor 'cluster' with n levels
n <- nlevels(clus_df_gather_sorted$cluster)

# Get all n! permutations of labels 1 to n
perms <- gtools::permutations(n, n)

# Original cluster levels
orig_levels <- levels(clus_df_gather_sorted$cluster)

# Loop over permutations
objective_minimum = 999999999
objectives <- numeric(nrow(perms))
for (i in 1:nrow(perms)) {
  new_labels <- perms[i, ]  # as.character(perms[i, ])
  
  # # Create a relabeled copy
  # clus_permuted <- clus_df_gather_sorted %>%
  #   mutate(cluster = factor(cluster, levels = orig_levels, labels = new_labels))

  map_dict <- setNames(new_labels, orig_levels)
  clus_permuted_objective <- determine_crossing_edges(clus_df_gather_sorted, column1 = "tissue", column2 = "cluster", map_dict = map_dict, return_weighted_layer_free_objective = TRUE)
  
  objectives[i] <- clus_permuted_objective
  
  if (clus_permuted_objective < objective_minimum) {
      clus_permuted_best <- clus_df_gather_sorted %>%
        mutate(cluster = factor(cluster, levels = orig_levels, labels = new_labels))
  }
}
```

```{r}
clus_permuted_best
```


```{r}
p_best <- plot_alluvial(clus_permuted_best, column1="tissue", column2="cluster", column_weights = "value")
p_best
```


```{r}
df_plot <- data.frame(
  perm_id = seq_along(objectives),
  objective = sort(objectives)
)

ggplot(df_plot, aes(x = perm_id, y = objective)) +
  geom_point() +
  geom_hline(yintercept = alluvialmatch_objective, linetype = "dashed", color = "blue") +
  annotate("text", x = Inf, y = alluvialmatch_objective, label = "alluvialmatch objective", 
           hjust = 1.1, vjust = -0.5, color = "blue", size = 3) +
  labs(x = "Permutation index", y = "Objective value") +
  theme_minimal()

```

```{r}
sessioninfo::session_info()
```
