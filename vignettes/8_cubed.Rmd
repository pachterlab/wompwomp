---
output:
  pdf_document: default
  html_document: default
---
```{r}
devtools::load_all()
# library(alluvialmatch)
library(dplyr)
library(ggplot2)
library(ggalluvial)
library(ggforce)
library(igraph)
library(tibble)

library(reticulate)
conda_env <- "seurat_vs_scanpy"
Sys.setenv(RETICULATE_PYTHON = paste("/Users/joeyrich/miniconda3/envs", conda_env, "bin/python3.9", sep = "/"))
use_condaenv("/Users/joeyrich/miniconda3/envs/seurat_vs_scanpy/bin/python3.9", required = TRUE)
```

```{r}
grouped_file_path <- "/Users/joeyrich/Downloads/Akr1c21_Slc7a12_grouped.csv"
graphing_columns <- c("Gene", "individual", "Sex", "Genotype", "Tissue", "Celltype_final")
```


```{r}
clus_df_gather <- read.csv(grouped_file_path)
clus_df_gather$value <- round(clus_df_gather$value)  # round to nearest whole number
print(nrow(clus_df_gather))
clus_df_gather
```

```{r}
unsorted_objective <- determine_crossing_edges(clus_df_gather, graphing_columns = graphing_columns, column_weights = "value", return_weighted_layer_free_objective = TRUE)
print(unsorted_objective)

p_unsorted <- plot_alluvial(clus_df_gather, graphing_columns = graphing_columns, column_weights = "value", sorting_algorithm = "None", color_bands=TRUE)
p_unsorted
```

```{r}
optimize_column_order <- FALSE
optimize_column_order_per_cycle <- FALSE

print(Sys.time())
p_sorted_fixed_columns <- plot_alluvial(clus_df_gather, graphing_columns = graphing_columns, column_weights = "value", sorting_algorithm = "neighbornet", optimize_column_order = optimize_column_order, optimize_column_order_per_cycle = optimize_column_order_per_cycle, color_bands=TRUE)
print(Sys.time())

p_sorted_fixed_columns
```

```{r}
optimize_column_order <- TRUE
optimize_column_order_per_cycle <- FALSE

print(Sys.time())
p_sorted_optimized_columns <- plot_alluvial(clus_df_gather, graphing_columns = graphing_columns, column_weights = "value", sorting_algorithm = "neighbornet", optimize_column_order = optimize_column_order, optimize_column_order_per_cycle = optimize_column_order_per_cycle, color_bands=TRUE)
print(Sys.time())

p_sorted_optimized_columns
```



Now remove the last column
```{r}
graphing_columns_summed <- c("Gene", "individual", "Sex", "Genotype", "Tissue")
clus_df_gather_summed <- clus_df_gather %>%
  dplyr::group_by(Gene, individual, Sex, Genotype, Tissue) %>%
  dplyr::summarise(value = sum(value), .groups = "drop")
print(nrow(clus_df_gather_summed))
```

```{r}
clus_df_gather_summed_processed <- data_preprocess(df = clus_df_gather_summed, graphing_columns = graphing_columns_summed, column_weights = "value", load_df = FALSE, do_gather_set_data = FALSE)
unsorted_objective_trimmed <- determine_crossing_edges(clus_df_gather_summed_processed, graphing_columns = graphing_columns_summed, column_weights = "value", return_weighted_layer_free_objective = TRUE)
print(unsorted_objective_trimmed)

p_unsorted_trimmed <- plot_alluvial(clus_df_gather_summed, graphing_columns = graphing_columns_summed, column_weights = "value", sorting_algorithm = "None", color_bands=TRUE)
p_unsorted_trimmed
```

```{r}
optimize_column_order <- FALSE
optimize_column_order_per_cycle <- FALSE

print(Sys.time())
p_sorted_fixed_columns_trimmed <- plot_alluvial(clus_df_gather_summed, graphing_columns = graphing_columns_summed, column_weights = "value", sorting_algorithm = "neighbornet", optimize_column_order = optimize_column_order, optimize_column_order_per_cycle = optimize_column_order_per_cycle, color_bands=TRUE, verbose=TRUE)
print(Sys.time())

p_sorted_fixed_columns_trimmed
```

```{r}
optimize_column_order <- TRUE
optimize_column_order_per_cycle <- FALSE

devtools::load_all()

print(Sys.time())
p_sorted_optimized_columns_trimmed <- plot_alluvial(clus_df_gather_summed, graphing_columns = graphing_columns_summed, column_weights = "value", sorting_algorithm = "neighbornet", optimize_column_order = optimize_column_order, optimize_column_order_per_cycle = optimize_column_order_per_cycle, color_bands=TRUE, verbose=TRUE)
print(Sys.time())

p_sorted_optimized_columns_trimmed
```


```{r}
optimize_column_order <- TRUE
optimize_column_order_per_cycle <- FALSE

devtools::load_all()

print(Sys.time())
p_sorted_optimized_columns_trimmed <- plot_alluvial(clus_df_gather_summed, graphing_columns = graphing_columns_summed, column_weights = "value", sorting_algorithm = "neighbornet", optimize_column_order = optimize_column_order, optimize_column_order_per_cycle = optimize_column_order_per_cycle, color_bands=TRUE, verbose=TRUE)
print(Sys.time())

p_sorted_optimized_columns_trimmed
```
