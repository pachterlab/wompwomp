---
title: "Introduction to alluvialmatch"
output: rmarkdown::html_vignette
vignette: >
  %\VignetteIndexEntry{Introduction to alluvialmatch}
  %\VignetteEngine{knitr::rmarkdown}
  %\VignetteEncoding{UTF-8}
---

```{r}
devtools::load_all()
# library(alluvialmatch)
library(dplyr)
library(ggplot2)
library(ggalluvial)
library(ggforce)
library(igraph)
library(tibble)
```

We create a toy data frame that maps tissues (brain, stomach, heart, T cell, B cell) to clustering (1-4)
```{r}
df <- data.frame(
  tissue = c(
    1, 1, 1,
    2, 2, 2, 2, 2, 2,
    3, 3, 3, 3, 3, 3, 3,
    4, 4,
    5, 5, 5, 5, 5, 5, 5, 5, 5
  ),
  cluster = c(
    1, 1, 2,
    1, 2, 2, 2, 2, 2,
    1, 3, 3, 3, 3, 3, 3,
    4, 4,
    4, 4, 4, 4, 4, 4, 4, 4, 4
  )
)

head(df)
```

Implementing a greedy heuristic for weighted one-layer free problem
```{r}
clus_df_gather_sorted <- greedy_wolf(df, column1="tissue", column2="cluster")
alluvialmatch_objective <- determine_crossing_edges(clus_df_gather_sorted, column1 = "tissue", column2 = "cluster", return_weighted_layer_free_objective = TRUE)
```

Find ARI
```{r}
ari_value <- mclust::adjustedRandIndex(df$tissue, df$cluster)
```

```{r}
generate_df_with_given_ari <- function(ari, number_entries = 1000, column1_cluster_number = 10, column2_cluster_number = 10, column1 = "tissue", column2 = "cluster") {
    df <- setNames(
      data.frame(
        sample(1:column1_cluster_number, number_entries, TRUE),
        sample(1:column2_cluster_number, number_entries, TRUE)
      ),
      c(column1, column2)
    )
    
    # MCMC here
    
    return(df)
}
```

```{r}
# min, max, spacing
left_cluster_number_range <- c(2, 30, 3)
right_cluster_number_range <- c(2, 30, 3)
ari_range <- c(0, 1, 0.1667)
number_entries <- 1000

left_cluster_number_seq <- seq(from = left_cluster_number_range[1], to = left_cluster_number_range[2], by = left_cluster_number_range[3])
right_cluster_number_seq <- seq(from = right_cluster_number_range[1], to = right_cluster_number_range[2], by = right_cluster_number_range[3])
ari_seq <- seq(from = ari_range[1], to = ari_range[2], by = ari_range[3])

results_df <- data.frame(left_cluster_number = numeric(), right_cluster_number = numeric(), r_squared = numeric())

for (m in left_cluster_number_seq) {
  for (n in right_cluster_number_seq) {
    inner_results_df <- data.frame(ari_value = numeric(), alluvialmatch_objective = numeric())
    for (r in ari_seq) {
      df <- generate_df_with_given_ari(
        ari = r,
        column1_cluster_number = m,
        column2_cluster_number = n,
        number_entries = number_entries
      )
      
      ari_value <- mclust::adjustedRandIndex(df$tissue, df$cluster)
      
      clus_df_gather_sorted <- greedy_wolf(df, column1 = "tissue", column2 = "cluster")
      alluvialmatch_objective <- determine_crossing_edges(
        clus_df_gather_sorted,
        column1 = "tissue",
        column2 = "cluster",
        return_weighted_layer_free_objective = TRUE
      )
      
      inner_results_df <- rbind(
        inner_results_df,
        data.frame(ari_value = ari_value, alluvialmatch_objective = alluvialmatch_objective)
      )
    }
    r_squared <- summary(lm(alluvialmatch_objective ~ ari_value, data = inner_results_df))$r.squared
      
    results_df <- rbind(
      results_df,
      data.frame(left_cluster_number = m, right_cluster_number = n, r_squared = r_squared)
    )
  }
}
```

Heatmap of results
```{r}
ggplot(results_df, aes(x = factor(right_cluster_number), y = factor(left_cluster_number), fill = r_squared)) +
  geom_tile() +
  scale_fill_gradient(low = "white", high = "blue") +
  labs(
    x = "Right cluster number",
    y = "Left cluster number",
    fill = "RÂ²"
  ) +
  theme_minimal()
```


```{r}
sessioninfo::session_info()
```
